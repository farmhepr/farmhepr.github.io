<!doctype html>
<html lang="pt">
<head>
  <title>Stock AUX - Scanner</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css" integrity="sha384-SI27wrMjH3ZZ89r4o+fGIJtnzkAnFs3E4qz9DIYioCQ5l9Rd/7UAa8DHcaL8jkWt" crossorigin="anonymous">
</head>

<body>
  <div class="container-sm">
    
  <div>
    <video id="video"  style="border: 1px solid gray"></video>
  </div>

  <div id="sourceSelectPanel" style="display:none">
    <label for="sourceSelect">Change video source:</label>
    <select id="sourceSelect" style="max-width:400px">
    </select>
  </div>

  <label>Result:</label>
  <pre><code id="result"></code></pre>
  <a id="bclink"> 
  <h4 id="barcode"></h4>
  </a>

  </div>
  <div w3-include-html="nav.html"></div>
  <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="utility.js" type="text/javascript"></script>
  <script type="text/javascript">
  includeHTML();

  window.addEventListener('load', function () {
    let selectedDeviceId;
    const codeReader = new ZXing.BrowserMultiFormatReader()
    console.log('ZXing code reader initialized')
    codeReader.getVideoInputDevices()
      .then((videoInputDevices) => {
        const sourceSelect = document.getElementById('sourceSelect')
        selectedDeviceId = videoInputDevices[0].deviceId
        if (videoInputDevices.length >= 1) {
          videoInputDevices.forEach((element) => {
            const sourceOption = document.createElement('option')
            sourceOption.text = element.label
            sourceOption.value = element.deviceId
            sourceSelect.appendChild(sourceOption)
          })
          sourceSelect.onchange = () => {
            selectedDeviceId = sourceSelect.value;
          };
          const sourceSelectPanel = document.getElementById('sourceSelectPanel')
          sourceSelectPanel.style.display = 'block'
          sourceSelect.value = videoInputDevices[videoInputDevices.length-1].deviceId
        }
        startVideo(codeReader);
        document.getElementById('sourceSelect').addEventListener('change', () => {
          codeReader.reset()
          codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
            if (result) {
              console.log(result)
              document.getElementById('result').textContent = result.text
              document.getElementById('bclink').href = "/?bar_code="+result.text
              document.getElementById('barcode').textContent = result.text

            }
            if (err && !(err instanceof ZXing.NotFoundException)) {
              console.error(err)
              document.getElementById('result').textContent = err
            }
          })
          console.log(`Started continous decode from camera with id ${selectedDeviceId}`)
        })
      })
      .catch((err) => {
        console.error(err)
      })
  })

  function startVideo(codeReader){
    var selectedDeviceId = document.getElementById('sourceSelect').value
    codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
      if (result) {
        console.log(result)
        document.getElementById('result').textContent = result.text
        document.getElementById('bclink').href = "/?bar_code="+result.text
        document.getElementById('barcode').textContent = result.text

      }
      if (err && !(err instanceof ZXing.NotFoundException)) {
        console.error(err)
        document.getElementById('result').textContent = err
      }
    })
    console.log(`Started continous decode from camera with id ${selectedDeviceId}`)
  }
  </script>
</body>
</html>