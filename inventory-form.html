<!doctype html>
<html lang="pt">

<head>
  <title>Stock AUX - Inventário</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css"
    integrity="sha384-SI27wrMjH3ZZ89r4o+fGIJtnzkAnFs3E4qz9DIYioCQ5l9Rd/7UAa8DHcaL8jkWt" crossorigin="anonymous">
  <style>
    .center {
      margin-left: auto;
      margin-right: auto;
      display: block
    }
  </style>
</head>

<body>
  <div w3-include-html="nav.html"></div>

  <div class="form-row">
    <div class="col">
      <button id="authorize_button" class="btn btn-primary mb-2" style="display: none;">Login</button>
    </div>
    <div class="col">
      <button id="signout_button" class="btn btn-primary mb-2" style="display: none;">Logoff</button>
    </div>
  </div>
  <h4 align="center">Inventário</h4>
  <div id="scanner-div" style="display: none;">
    <video id="video" class="center" style="max-width:80%; border: 1px solid gray"></video>
    <div id="sourceSelectPanel" class="center" style="display:none">
      <label for="sourceSelect">Selecionar camera:</label>
      <select id="sourceSelect" style="max-width:80%">
      </select>
    </div>
  </div>
  <div class="container-sm">

    <div class="form-group">
      <label>Código de barras</label>
      <div class="form-row">
        <div class="col-6">
          <input type="search" class="form-control" id="bar_code" />
        </div>
        <div class="col">
          <button id="searchCode" onclick="getSheet('BarCode!A2:D', updateFormBarCode); 
        document.getElementById('scanner-div').style.display='none';
        " class="btn btn-primary mb-2">Buscar</button>
        </div>
        <div class="col">
          <button id="startScanner" onclick="document.getElementById('scanner-div').style.display='block';"
            class="btn btn-primary mb-2">Scanner</button>

        </div>
      </div>
      <select id="barCodeSelection" class="form-control" onchange="updateFormSelectBarCode();
        getSheet('ProdutoLote!A1:D', 
          function(data) {
            updateFormMedName(data);
            data = data.filter(function (el) { return el[0] == document.getElementById('medInput').value; });
            createTable(data,'medicamentList',ignore=[2], caption='ESTOQUE')
          });
          getSheet('Inventario!E1:H', 
          function(data) {
            data = data.filter(function (el) { return el[0] == document.getElementById('medInput').value; });
           createTable(data,'inventoryList', ignore=[2], caption='INVENTARIO')})"
        style="width:100%;max-width:90%;"></select>

    </div>
    <div id="form-register" >
      <div class="form-group">
        <label for="medInput">Medicamento</label>
        <input type="search" class="form-control" list="medicamentSelection" id='medInput' name="medicament" onchange="
        getSheet('ProdutoLote!A1:D', 
          function(data) {
            updateFormMedName(data);
            data = data.filter(function (el) { return el[0] == document.getElementById('medInput').value; });
            createTable(data,'medicamentList',ignore=[2], caption='ESTOQUE')
          });
          getSheet('Inventario!E1:H', 
          function(data) {
            data = data.filter(function (el) { return el[0] == document.getElementById('medInput').value; });
           createTable(data,'inventoryList', ignore=[2], caption='INVENTARIO')})">
        <datalist id="medicamentSelection">
        </datalist>
      </div>

      <div class="form-group">
        <label for="seriesInput">Lote</label>
        <input type="search" class="form-control" list="seriesSelection" id='seriesInput' name="series"
          onchange="valSel()">
        <datalist id="seriesSelection">
        </datalist>
      </div>

      <div class="form-group">
        <label for="valInput">Validade</label>
        <input type="search" class="form-control" list="valDateSelection" id='valInput' name="valDate">
        <datalist id="valDateSelection">
        </datalist>
      </div>


      <div class="form-group">
        <label for="qnt">Quantidade</label>
        <div class="form-row">
          <div class="col">
            <input type="search" class="form-control" type="number" id='qnt' name="qnt">
          </div>

          <div class="col">

            <button onclick="sendInventory()" class="btn btn-primary">Enviar Saída</button>
          </div>
          <div class="col">

            <button id="sendCodId" align="right" class="btn btn-primary" style="display: none;"
              onclick="sendCod()">Cadatrar Código</button>
          </div>
        </div>
      </div>
    </div>
    <div class="table-responsive-lg" style="max-width: 90%;">
      <table class="table" style="font-size:11px" id="medicamentList">

      </table>
      <table class="table" style="font-size:11px" id="inventoryList">

      </table>
    </div>
  </div>
  <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="utility.js" type="text/javascript"></script>
  <script type="text/javascript">
    includeHTML();

    window.addEventListener('load', function () {
      let selectedDeviceId;
      const codeReader = new ZXing.BrowserMultiFormatReader()
      console.log('ZXing code reader initialized')
      codeReader.getVideoInputDevices()
        .then((videoInputDevices) => {
          const sourceSelect = document.getElementById('sourceSelect')
          selectedDeviceId = videoInputDevices[0].deviceId
          if (videoInputDevices.length >= 1) {
            videoInputDevices.forEach((element) => {
              const sourceOption = document.createElement('option')
              sourceOption.text = element.label
              sourceOption.value = element.deviceId
              sourceSelect.appendChild(sourceOption)
            })
            sourceSelect.onchange = () => {
              selectedDeviceId = sourceSelect.value;
            };
            const sourceSelectPanel = document.getElementById('sourceSelectPanel')
            sourceSelectPanel.style.display = 'block'
            sourceSelect.value = videoInputDevices[videoInputDevices.length - 1].deviceId
          }

          document.getElementById('startScanner').addEventListener('click', () => {
            document.getElementById('bar_code').value = '';
            startVideo(codeReader);
          })

          document.getElementById('searchCode').addEventListener('click', () => {
            codeReader.reset();
            console.log('Reset.')
          })

          document.getElementById('sourceSelect').addEventListener('change', () => {
            codeReader.reset()
            codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
              if (result) {
                console.log(result)
                document.getElementById('bar_code').value = result.text
              }
              if (err && !(err instanceof ZXing.NotFoundException)) {
                console.error(err)
                alert(err)
              }
            })
            console.log(`Started continous decode from camera with id ${selectedDeviceId}`)
          })
        })
        .catch((err) => {
          console.error(err)
        })
    })

    function startVideo(codeReader) {
      var selectedDeviceId = document.getElementById('sourceSelect').value
      codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
        if (result) {
          console.log(result)
          document.getElementById('bar_code').value = result.text
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error(err)
          document.getElementById('result').textContent = err
        }
      })
      console.log(`Started continous decode from camera with id ${selectedDeviceId}`)
    }
  </script>
  <script src="gsheets.js" type="text/javascript"></script>

  <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad(
      function(){
        initClient(function(){
        getSheet('Medicamentos!A2:A',updateMeds);
        var barCodeVal = getAllUrlParams().bar_code;
        console.log(barCodeVal);
        if(!(typeof (barCodeVal) === 'undefined')) {
          document.getElementById('bar_code').value = barCodeVal;
          var barCodeData = getSheet('BarCode!A2:D', updateFormBarCode);
        }
      });
    }
    )" onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
</body>

</html>